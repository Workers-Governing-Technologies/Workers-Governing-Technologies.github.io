<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Workers' Thought Constellation</title>
    <style>
        :root {
            --bg-color: #050510;
            --text-color: #e0e0e0;
            --panel-bg: rgba(10, 15, 30, 0.9);
            --border-color: rgba(255, 255, 255, 0.15);
            
            /* Theme Colors - Slightly brightened for clarity */
            --color-creativity: #00f2ff; /* Cyan */
            --color-rights: #ff4757;     /* Red */
            --color-democracy: #ffa502;  /* Orange */
            --color-data: #2ed573;       /* Green */
            --color-equity: #ff6b81;     /* Pink */
            --color-economy: #a55eea;    /* Purple */
            --color-policy: #f1c40f;     /* Yellow */
            --color-environment: #1e90ff;/* Blue */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace; 
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2rem;
        }

        header {
            pointer-events: auto;
            max-width: 600px;
            background: radial-gradient(circle at top left, rgba(5,5,16,0.8) 0%, transparent 70%);
            padding: 20px;
            border-radius: 8px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 15px rgba(255,255,255,0.2);
            line-height: 1.2;
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 1.5rem;
            border-left: 2px solid var(--color-creativity);
            padding-left: 10px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            color: white;
            padding: 8px 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .btn:hover, .btn.active {
            background: white;
            color: black;
            border-color: white;
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            pointer-events: auto;
            transition: opacity 0.5s;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            padding: 4px 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid transparent;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .legend-item:hover { 
            background: rgba(255,255,255,0.15); 
            border-color: rgba(255,255,255,0.3);
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; }

        /* Loudspeaker Panel */
        #loudspeaker-panel {
            pointer-events: auto;
            position: absolute;
            bottom: 2rem;
            right: 2rem;
            width: 450px;
            max-width: 90vw;
            background: var(--panel-bg); 
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            backdrop-filter: blur(12px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transform: translateY(0);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 80vh; 
            z-index: 100;
        }

        #loudspeaker-panel.hidden {
            transform: translateY(120%);
        }

        .panel-header {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
            color: rgba(255,255,255,0.6);
        }

        #thought-category { font-weight: bold; color: white; }

        #thought-display {
            font-size: 1.1rem;
            line-height: 1.6;
            min-height: 80px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        /* Styled Scrollbar */
        #thought-display::-webkit-scrollbar { width: 4px; }
        #thought-display::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        #thought-display::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); }

        .instruction {
            font-size: 0.7rem;
            opacity: 0.5;
            text-align: right;
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
        }
        .instruction:hover { opacity: 1; text-decoration: underline; }

        /* Final Slogan Backdrop */
        #final-slogan-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            opacity: 0;
            transition: opacity 2s ease-in-out;
            z-index: 0; 
            pointer-events: none;
            width: 100%;
        }

        #final-slogan-text {
            font-family: 'Inter', system-ui, sans-serif; /* Cleaner font for the backdrop */
            font-weight: 900;
            font-size: 5vw; 
            color: rgba(255, 255, 255, 0.3); /* Higher opacity for better legibility */
            line-height: 1.1;
            white-space: pre-wrap;
            letter-spacing: -2px;
        }

        /* Tooltip */
        #tooltip {
            position: absolute;
            pointer-events: none;
            background: rgba(10, 15, 30, 0.95);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 12px;
            font-size: 0.8rem;
            max-width: 250px;
            display: none;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        @media (max-width: 768px) {
            #loudspeaker-panel {
                bottom: 0;
                right: 0;
                width: 100%;
                border-bottom: none;
                max-height: 50vh;
            }
            .legend { display: none; }
            h1 { font-size: 1.4rem; }
            #final-slogan-text { font-size: 8vw; }
        }
    </style>
</head>
<body>

    <div id="final-slogan-container">
        <div id="final-slogan-text">WORKERS'<br>GOVERNING<br>TECHNOLOGY</div>
    </div>

    <div id="canvas-container">
        <canvas id="constellation-canvas"></canvas>
    </div>

    <div id="ui-layer">
        <header>
            <h1>THE WORKERS' THOUGHT CONSTELLATION</h1>
            <div class="subtitle">Mapping Our Participants' Perspectives</div>
            
            <div class="controls">
                <button class="btn active" id="btn-constellation" onclick="setMode('constellation')">Constellation</button>
                <button class="btn" id="btn-slogan" onclick="setMode('slogan')">The Demand</button>
            </div>

            <div class="legend" id="main-legend">
                <div class="legend-item" onclick="filterNodes('creativity')"><div class="dot" style="background:var(--color-creativity)"></div>Creativity</div>
                <div class="legend-item" onclick="filterNodes('rights')"><div class="dot" style="background:var(--color-rights)"></div>Rights</div>
                <div class="legend-item" onclick="filterNodes('democracy')"><div class="dot" style="background:var(--color-democracy)"></div>Democracy</div>
                <div class="legend-item" onclick="filterNodes('data')"><div class="dot" style="background:var(--color-data)"></div>Data</div>
                <div class="legend-item" onclick="filterNodes('equity')"><div class="dot" style="background:var(--color-equity)"></div>Equity</div>
                <div class="legend-item" onclick="filterNodes('economy')"><div class="dot" style="background:var(--color-economy)"></div>Economy</div>
                <div class="legend-item" onclick="filterNodes('policy')"><div class="dot" style="background:var(--color-policy)"></div>Policy</div>
                <div class="legend-item" onclick="filterNodes('environment')"><div class="dot" style="background:var(--color-environment)"></div>Environment</div>
            </div>
        </header>

        <div id="loudspeaker-panel" class="hidden">
            <div class="panel-header">
                <span>Signal Received</span>
                <span id="thought-category">THEME</span>
            </div>
            <div id="thought-display">
                Hover over a node to preview. Click to lock signal.
            </div>
            <div class="instruction" id="close-panel-btn">
                [CLOSE TRANSMISSION]
            </div>
        </div>
    </div>

    <div id="tooltip"></div>

    <script>
        // --- DATA & CONFIG ---
        
        const themes = {
            creativity: { color: '#00f2ff', label: 'Creativity & Autonomy' },
            rights: { color: '#ff4757', label: 'Rights, Governance & Solidarity' },
            democracy: { color: '#ffa502', label: 'Workplace Democracy' },
            data: { color: '#2ed573', label: 'Data, Research & Commons' },
            equity: { color: '#ff6b81', label: 'Equity & Inclusion' },
            economy: { color: '#a55eea', label: 'Alternative Economy' },
            policy: { color: '#f1c40f', label: 'Policy & Advocacy' },
            environment: { color: '#1e90ff', label: 'Environment' }
        };

        function cleanText(text) {
            return text
                .replace(/some of us\s*lcome/gi, "welcome")
                .replace(/some of us\s*r/gi, "power")
                .replace(/betsome of us\s*en/gi, "between")
                .replace(/some of us\s*llbeing/gi, "wellbeing")
                .replace(/outsome of us\s*ighs/gi, "outweighs")
                .replace(/some of us/gi, "We"); 
        }

        const rawData = [
            { t: "creativity", text: "A writer can only be identified as a human being. Technology is a tool, never the creator." },
            { t: "creativity", text: "AI must never be pushed on a worker. It is our choice to use it." },
            { t: "economy", text: "We reject the narrative that AI is 'inevitable.' Profits for the few do not justify the exploitation of the many." },
            { t: "rights", text: "We reject the 'inevitability' of technology that depends on the theft of our labour." },
            { t: "rights", text: "We demand compensation and consent for the use of our archives." },
            { t: "policy", text: "Government deregulation should not be a tool for corporations to bypass union contracts." },
            { t: "policy", text: "We welcome solidarity and expertise to strengthen our in-house policy capacity." },
            { t: "environment", text: "Majority world cannot be the 'sacrificial zones' for Data centre expansions." },
            { t: "environment", text: "Innovation cannot run on the environmental ruin of our small towns." },
            { t: "environment", text: "The right of our community to access drinking water outweighs the right of a tech company to train a dataset." },
            { t: "data", text: "We demand the immediate enforcement of data protection and IP laws." },
            { t: "rights", text: "Artists, academics, environmentalists, and all citizens stand united against corporate encroachment." },
            { t: "creativity", text: "We refuse to let our active creativity be reduced to data points used against us." },
            { t: "data", text: "Transparency in worker data: what is collected, why, and how it is used." },
            { t: "democracy", text: "Fair profits through transparent productivity metrics." },
            { t: "rights", text: "Workers must have the right to refuse tasks assigned by an algorithm without fear of sanction." },
            { t: "democracy", text: "We demand the right to see and negotiate the metrics used to estimate worker productivity." },
            { t: "democracy", text: "Stopping automated punishments on workers; human review is mandatory." },
            { t: "democracy", text: "Establish joint committees on health, safety and technology." },
            { t: "data", text: "Data sovereignty: core digital infrastructures must be managed as public goods." },
            { t: "rights", text: "We will call out corporations that use AI as a convenient excuse for job cuts." },
            { t: "democracy", text: "We resolve to build our own technical resources to strengthen union organization." },
            { t: "equity", text: "We reject the divide between 'high-skill' workers and 'low-skill' workers." },
            { t: "rights", text: "Mergers must sign neutrality agreements that prevent interference with our right to organize." },
            { t: "democracy", text: "Checklists to monitor every workplace for unreported software deployments." },
            { t: "democracy", text: "We demand a notice period for any technological change in our workplace." },
            { t: "economy", text: "We promote open-source software (like CoopCycle) that belongs to the workers." },
            { t: "equity", text: "We commit to anti-harassment protocols and promoting leadership roles for women and gender-diverse individuals." },
            { t: "economy", text: "Building worker-owned platform cooperatives to replace big tech." },
            { t: "economy", text: "We strive to build a fully alternative economy with our own credit unions and social safety nets." },
            { t: "democracy", text: "We use the union as a vital resource for conflict resolution." },
            { t: "creativity", text: "We demand an economy that provides artists with the mental space to be creative." },
            { t: "rights", text: "We declare internet access a fundamental human right." },
            { t: "policy", text: "We prioritize secure, internal applications to protect social movements from surveillance." },
            { t: "economy", text: "We reject the predatory nature of gig apps; gig workers are workers, not contractors." },
            { t: "economy", text: "When private owners abandon companies, workers have a right to the technical support to reclaim them." },
            { t: "data", text: "We reject 'one-size-fits-all' software models. We champion tools that reflect plural realities." },
            { t: "data", text: "Translation of academic research into practical technical assistance for the worker on the shop floor." },
            { t: "economy", text: "We reject the 'rent extraction' model where outside investors skim value from creators." },
            { t: "data", text: "Data systems must preserve the right to be forgotten and the right to be credited." },
            { t: "equity", text: "We acknowledge the systemic exclusion of trans people from formal education." },
            { t: "equity", text: "We assert that people performing data labeling are the primary experts on AI harms." },
            { t: "data", text: "We move beyond being 'documented' by academics to identifying our own issues (worker inquiry)." },
            { t: "democracy", text: "Inter-cooperation to create safe environments for junior members to learn." },
            { t: "creativity", text: "We 'dare to desire' new forms of technology that prioritize human joy and rest." },
            { t: "data", text: "We reject proprietary licensing and embrace Creative Commons." },
            { t: "policy", text: "We use collective knowledge to influence legislators for public policies that protect the solidarity economy." },
            { t: "policy", text: "The state must investigate the 'black box' of platform algorithms." },
            { t: "policy", text: "Demand that platform policies be written in the native language of the workers." }
        ];

        const slogans = [
            { t: "creativity", text: "WE ARE NOT DATA POINTS" },
            { t: "rights", text: "THE RIGHT TO REFUSE" },
            { t: "environment", text: "WATER > DATA CENTERS" },
            { t: "democracy", text: "NO ALGORITHMIC MANAGERS, WHERE ARE THE HUMANS?" },
            { t: "data", text: "DATA SOVEREIGNTY" },
            { t: "economy", text: "WORKER-OWNED TECHNOLOGIES" },
            { t: "policy", text: "OPEN THE BLACK BOX" },
            { t: "equity", text: "NOTHING ABOUT US WITHOUT US" },
            { t: "economy", text: "PUBLIC GOODS, NOT MONOPOLIES" },
            { t: "creativity", text: "REST IS OUR RIGHT" },
            { t: "rights", text: "AI, STOP STEALING OUR WORK" },
            { t: "policy", text: "YOU SAY INNOVATION, WE SAY ITS EXPLOITATION" }
        ];

        // --- SIMULATION SETUP ---

        const canvas = document.getElementById('constellation-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // State Variables
        const START_TIME = Date.now();
        const TRANSITION_DELAY = 60000; 
        let currentMode = 'constellation'; 

        // Particle System
        let nodes = [];
        const TARGET_NODE_COUNT = 500; // Increased for higher density
        const connectionsDistance = 140; 
        const equilibriumDistance = 120;
        const mouseDistance = 200;

        // Interaction State
        const mouse = { x: null, y: null };
        let activeFilter = null;
        let selectedNode = null;

        // Initialize Data
        function initData() {
            nodes = [];

            // 1. Add Major Slogan Nodes
            slogans.forEach(item => {
                nodes.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 0.05,
                    vy: (Math.random() - 0.5) * 0.05,
                    text: item.text,
                    category: item.t,
                    color: themes[item.t].color,
                    radius: 6, 
                    isSlogan: true,
                    hovered: false,
                    targetX: null,
                    targetY: null,
                    locked: false // New property for snap-to-grid
                });
            });

            // 2. Fill with Standard Thoughts
            let dataIndex = 0;
            while (nodes.length < TARGET_NODE_COUNT) {
                const item = rawData[dataIndex % rawData.length];
                nodes.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 0.1,
                    vy: (Math.random() - 0.5) * 0.1,
                    text: cleanText(item.text),
                    category: item.t,
                    color: themes[item.t].color,
                    radius: Math.random() * 2 + 1, // Slightly smaller variance
                    isSlogan: false,
                    hovered: false,
                    targetX: null,
                    targetY: null,
                    locked: false
                });
                dataIndex++;
            }
        }

        // --- SLOGAN FORMATION LOGIC ---

        function calculateSloganTargets() {
            // 1. Create temporary canvas
            const tempCanvas = document.createElement('canvas');
            const tCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;

            // 2. Settings - Matches CSS but higher contrast for sampling
            tCtx.fillStyle = 'black';
            tCtx.fillRect(0,0, width, height);
            tCtx.fillStyle = 'white';
            // Use a bold sans-serif for cleaner edge detection
            tCtx.font = '900 ' + (width * 0.05) + 'px Inter, system-ui, sans-serif'; 
            tCtx.textAlign = 'center';
            tCtx.textBaseline = 'middle';
            
            // 3. Draw Text
            const lines = ["WORKERS'", "GOVERNING", "TECHNOLOGY"];
            const lineHeight = width * 0.06;
            const startY = height / 2 - lineHeight;
            
            lines.forEach((line, i) => {
                tCtx.fillText(line, width / 2, startY + (i * lineHeight));
            });

            // 4. Sample Pixels with Edge Detection
            // We want points ON the text, but also prioritize edges for sharpness
            const imageData = tCtx.getImageData(0, 0, width, height).data;
            let validPoints = [];
            let edgePoints = [];
            const step = 4; // High resolution sampling

            for (let y = 1; y < height - 1; y += step) {
                for (let x = 1; x < width - 1; x += step) {
                    const idx = (y * width + x) * 4;
                    if (imageData[idx] > 100) { // If pixel is white
                        // Check neighbors to see if it's an edge
                        const left = imageData[idx - 4];
                        const right = imageData[idx + 4];
                        const up = imageData[((y-1) * width + x) * 4];
                        const down = imageData[((y+1) * width + x) * 4];
                        
                        if (left < 100 || right < 100 || up < 100 || down < 100) {
                            edgePoints.push({x, y});
                        } else {
                            validPoints.push({x, y});
                        }
                    }
                }
            }

            // 5. Shuffle points
            validPoints.sort(() => Math.random() - 0.5);
            edgePoints.sort(() => Math.random() - 0.5);

            // 6. Assign targets
            // Prioritize edge points for sharpness, then fill
            let edgeIndex = 0;
            let fillIndex = 0;

            nodes.forEach((node, i) => {
                let target = null;
                
                // Distribute ~40% of nodes to edges for crisp outline
                if (i % 3 === 0 && edgeIndex < edgePoints.length) {
                    target = edgePoints[edgeIndex++];
                } else if (fillIndex < validPoints.length) {
                    target = validPoints[fillIndex++];
                } else if (edgeIndex < edgePoints.length) {
                    target = edgePoints[edgeIndex++];
                }

                if (target) {
                    node.targetX = target.x;
                    node.targetY = target.y;
                } else {
                    // Fallback to center if screen is massive
                    node.targetX = width/2;
                    node.targetY = height/2;
                }
                node.locked = false; // Reset lock state
            });
        }

        // --- MODE CONTROL ---

        window.setMode = function(mode) {
            currentMode = mode;
            
            // Update UI buttons
            document.getElementById('btn-constellation').classList.toggle('active', mode === 'constellation');
            document.getElementById('btn-slogan').classList.toggle('active', mode === 'slogan');

            const sloganContainer = document.getElementById('final-slogan-container');
            const legend = document.getElementById('main-legend');

            if (mode === 'slogan') {
                calculateSloganTargets();
                sloganContainer.style.opacity = '1';
                legend.style.opacity = '0';
                legend.style.pointerEvents = 'none';
            } else {
                sloganContainer.style.opacity = '0';
                legend.style.opacity = '1';
                legend.style.pointerEvents = 'auto';
                
                // Unlock all nodes
                nodes.forEach(n => {
                    n.locked = false;
                    // Give them a random nudge to break formation naturally
                    n.vx = (Math.random() - 0.5) * 2;
                    n.vy = (Math.random() - 0.5) * 2;
                });
            }
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            if(nodes.length === 0) initData();
            if (currentMode === 'slogan') calculateSloganTargets();
        }

        window.addEventListener('resize', resize);
        resize();

        // --- PHYSICS & RENDERING ---

        function animate() {
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, width, height);

            // Auto-trigger timer check
            if (currentMode === 'constellation' && Date.now() - START_TIME > TRANSITION_DELAY) {
                setMode('slogan');
            }

            ctx.lineWidth = 0.5;
            
            for (let i = 0; i < nodes.length; i++) {
                let p1 = nodes[i];
                
                // Skip if filtered out (only in constellation mode)
                if (currentMode === 'constellation' && activeFilter && p1.category !== activeFilter) {
                    continue; 
                }

                // --- MODE 1: CONSTELLATION ---
                if (currentMode === 'constellation') {
                    
                    // Connection Lines
                    for (let j = i + 1; j < nodes.length; j++) {
                        let p2 = nodes[j];
                        // Only connect relatively close indices to improve perf with 500 nodes
                        if (Math.abs(i - j) > 50 && p1.category === p2.category) continue; 

                        if (p1.category === p2.category) {
                            let dx = p2.x - p1.x;
                            let dy = p2.y - p1.y;
                            let dist = Math.sqrt(dx*dx + dy*dy);

                            if (dist < connectionsDistance) {
                                let opacity = 1 - (dist / connectionsDistance);
                                ctx.strokeStyle = `rgba(${hexToRgb(p1.color)}, ${opacity * 0.3})`;
                                ctx.beginPath();
                                ctx.moveTo(p1.x, p1.y);
                                ctx.lineTo(p2.x, p2.y);
                                ctx.stroke();

                                // Spring Force
                                const displacement = dist - equilibriumDistance;
                                const fx = (dx / dist) * displacement * 0.00005;
                                const fy = (dy / dist) * displacement * 0.00005;

                                p1.vx += fx;
                                p1.vy += fy;
                                p2.vx -= fx;
                                p2.vy -= fy;
                            }
                        }
                    }

                    // Mouse Repel
                    if (mouse.x != null) {
                        let dx = mouse.x - p1.x;
                        let dy = mouse.y - p1.y;
                        let dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < mouseDistance) {
                            const force = (mouseDistance - dist) / mouseDistance;
                            p1.vx -= (dx / dist) * force * 0.5;
                            p1.vy -= (dy / dist) * force * 0.5;
                        }
                    }
                    
                    // Friction & Gravity
                    p1.vx += (width/2 - p1.x) * 0.00001;
                    p1.vy += (height/2 - p1.y) * 0.00001;
                    p1.vx *= 0.99;
                    p1.vy *= 0.99;

                } 
                // --- MODE 2: SLOGAN (SNAP TO GRID) ---
                else if (currentMode === 'slogan' && p1.targetX !== null) {
                    
                    if (!p1.locked) {
                        const dx = p1.targetX - p1.x;
                        const dy = p1.targetY - p1.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        
                        // SNAP LOGIC: If very close, stop moving
                        if (dist < 1) {
                            p1.x = p1.targetX;
                            p1.y = p1.targetY;
                            p1.locked = true;
                        } else {
                            // Ease towards target
                            // Variable speed based on distance for natural feel
                            const speed = dist * 0.05 + 0.02;
                            p1.vx = dx * 0.05;
                            p1.vy = dy * 0.05;
                            
                            p1.vx *= 0.9;
                            p1.vy *= 0.9;
                        }
                    } else {
                        // Keep locked in place
                        p1.x = p1.targetX;
                        p1.y = p1.targetY;
                        p1.vx = 0;
                        p1.vy = 0;
                    }
                }

                // Update Position
                if (!p1.locked) {
                    p1.x += p1.vx;
                    p1.y += p1.vy;
                }

                // Bounce (Constellation only)
                if (currentMode === 'constellation') {
                    if (p1.x < 0 || p1.x > width) p1.vx *= -1;
                    if (p1.y < 0 || p1.y > height) p1.vy *= -1;
                }

                // Draw Node
                let isDimmed = currentMode === 'constellation' && activeFilter && p1.category !== activeFilter;
                
                ctx.beginPath();
                ctx.arc(p1.x, p1.y, isDimmed ? 1 : p1.radius, 0, Math.PI * 2);
                
                if (p1.hovered || p1 === selectedNode) {
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = p1.color;
                    ctx.fillStyle = '#ffffff';
                } else {
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = isDimmed ? '#333' : p1.color;
                }
                ctx.fill();
                ctx.shadowBlur = 0;

                // Draw Labels (Constellation only)
                if (currentMode === 'constellation' && p1.isSlogan && !isDimmed) {
                    ctx.font = 'bold 11px Courier New';
                    ctx.fillStyle = p1.color;
                    ctx.textAlign = 'center';
                    ctx.fillText(p1.text, p1.x, p1.y - 14);
                }
            }
        }

        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '255, 255, 255';
        }

        // --- INTERACTION ---

        canvas.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
            
            let hovering = false;
            let tooltip = document.getElementById('tooltip');

            // Optimize search: loop backwards, stop at first hit
            for (let i = nodes.length - 1; i >= 0; i--) {
                let node = nodes[i];
                let dx = mouse.x - node.x;
                let dy = mouse.y - node.y;
                // Simple box check first for speed
                if (Math.abs(dx) > 20 || Math.abs(dy) > 20) {
                    node.hovered = false;
                    continue;
                }
                
                let dist = Math.sqrt(dx*dx + dy*dy);
                const hitDist = node.isSlogan ? 30 : 15;

                if (dist < hitDist) {
                    node.hovered = true;
                    hovering = true;
                    
                    if (!node.isSlogan && currentMode === 'constellation') {
                        tooltip.style.display = 'block';
                        tooltip.style.left = (e.clientX + 15) + 'px';
                        tooltip.style.top = (e.clientY + 15) + 'px';
                        tooltip.innerText = themes[node.category].label;
                        tooltip.style.borderColor = node.color;
                    }
                    break; // Only hover one at a time
                } else {
                    node.hovered = false;
                }
            }

            if (!hovering) tooltip.style.display = 'none';
            canvas.style.cursor = hovering ? 'pointer' : 'default';
        });

        canvas.addEventListener('mouseleave', () => { mouse.x = null; mouse.y = null; });

        canvas.addEventListener('click', (e) => {
            for (let i = nodes.length - 1; i >= 0; i--) {
                let node = nodes[i];
                let dx = e.clientX - node.x;
                let dy = e.clientY - node.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                const hitDist = node.isSlogan ? 30 : 15;

                if (dist < hitDist) {
                    selectedNode = node;
                    displayThought(node);
                    return;
                }
            }
        });

        const panel = document.getElementById('loudspeaker-panel');
        const thoughtDisplay = document.getElementById('thought-display');
        const categoryDisplay = document.getElementById('thought-category');
        const closeBtn = document.getElementById('close-panel-btn');

        function displayThought(node) {
            panel.classList.remove('hidden');
            categoryDisplay.innerText = themes[node.category].label;
            categoryDisplay.style.color = node.color;
            thoughtDisplay.style.opacity = 0;
            setTimeout(() => {
                thoughtDisplay.innerHTML = `"${node.text}"`;
                thoughtDisplay.style.opacity = 1;
                thoughtDisplay.style.transition = "opacity 0.3s";
            }, 100);
            panel.style.boxShadow = `0 0 30px ${node.color}40`;
            panel.style.borderColor = node.color;
        }

        function closePanel() {
            panel.classList.add('hidden');
            selectedNode = null;
        }

        closeBtn.addEventListener('click', closePanel);

        window.filterNodes = function(category) {
            if (activeFilter === category) {
                activeFilter = null;
            } else {
                activeFilter = category;
            }
        }

        animate();

    </script>
</body>
</html>
